[image-id-a]: images/VM-save-virtual-machine-state-1.png
[image-id-b]: images/VM-save-virtual-machine-state-2.png
[image-id-с]: images/VM-save-virtual-machine-state-3.png
[image-id-1]: images/1-1-1-ipcalc.png
[image-id-2]: images/1-1-2-ipcalc.png
[image-id-3]: images/1-1-2-ipcalc-15.png
[image-id-4]: images/1-1-2-ipcalc-28.png
[image-id-5]: images/1-1-3-ipcalc-8.png
[image-id-6]: images/1-1-3-ipcalc-16.png
[image-id-7]: images/1-1-3-ipcalc-23.png
[image-id-8]: images/1-1-3-ipcalc-4.png
[image-id-8.1]: images/IP-adress_change_process.png
[image-id-8.2]: images/IP_table.png
[image-id-9]: images/2-ip-a.png
[image-id-9-0]: images/enp0s8-0.png
[image-id-9-1]: images/enp0s8-1.png
[image-id-9-2]: images/enp0s8-2.png
[image-id-9-3]: images/enp0s8-3.png
[image-id-9-4]: images/enp0s8-4.png
[image-id-9-5]: images/enp0s8-5.png
[image-id-9-6]: images/enp0s8-6.png
[image-id-9-7]: images/enp0s8-7.png
[image-id-9-8]: images/enp0s8-8.png
[image-id-9-9]: images/enp0s8-9.png
[image-id-10]: images/2-netplan.png
[image-id-10-1]: images/2-1-netplan.png
[image-id-11]: images/2-ip-r-add.png
[image-id-12]: images/2-2-netplan.png
[image-id-13]: images/3-iperf3.png
[image-id-14]: images/4-iptables.png
[image-id-15]: images/4-firewall-sh.png
[image-id-16]: images/4-ping-nmap.png
[image-id-16.1]: images/5-cloning-1.png
[image-id-16.2]: images/5-cloning-2.png
[image-id-16.3]: images/5-cloning-3.png
[image-id-16.4]: images/5-cloning-4.png
[image-id-17]: images/5-network.png
[image-id-17.1]: images/5-r1-network-adapter-1.png
[image-id-17.2]: images/5-r1-network-adapter-2.png
[image-id-17.3]: images/5-r2-network-adapter-1.png
[image-id-17.4]: images/5-r2-network-adapter-2.png
[image-id-17.5]: images/5-ws11-network-adapter.png
[image-id-17.6]: images/5-ws21-ws22-network-adapter.png
[image-id-18]: images/5-netplan-r1-r2.png
[image-id-19]: images/5-netplan-ws11-ws22-ws21.png
[image-id-20]: images/5-netplan-r1-r2-ip-4-a.png
[image-id-21]: images/5-netplan-ws11-ws22-ws21-ip-4-a.png
[image-id-22]: images/5-ping-r1-ws11-ws22-ws21.png
[image-id-23]: images/5-r1-r2-sysctl.png
[image-id-24]: images/5-r1-r2-sysctl-conf.png
[image-id-25]: images/5-netplan-ws11-ws22-ws21-default.png
[image-id-26]: images/5-netplan-ws11-ws22-ws21-default-ip-r.png
[image-id-27]: images/5-ws11-ping-r2.png
[image-id-27.1]: images/5-ws11-ping-r2_1.png
[image-id-27.2]: images/5-ws11-ping-r2_2.png
[image-id-28]: images/5-r1-r2-static.png
[image-id-29]: images/5-r1-r2-static-ip-r.png
[image-id-30]: images/5-ws11-netmask.png
[image-id-31]: images/5-r1-tcpdump-ws11-traceroute.png
[image-id-32]: images/5-r1-tcpdump-icmp-ws11-ping.png
[image-id-33]: images/6-r2-dhcp-dhcpd-dhcpd-conf.png
[image-id-34]: images/6-r2-resolv-conf.png
[image-id-35]: images/6-r2-restart-dhcp-ws21-reboot-ip-a.png
[image-id-36]: images/6-ping-ws22-ws21.png
[image-id-37.1]: images/6-ws11-macaddress_1.png
[image-id-37.2]: images/6-ws11-macaddress_2.png
[image-id-38]: images/6-r1-dhcp-dhcpd-dhcpd-conf.png
[image-id-39]: images/6-r1-resolv-conf.png
[image-id-40]: images/6-r1-restart-dhcp-ws11-reboot-ip-a.png
[image-id-41]: images/6-ws21-ping-a-before.png
[image-id-42]: images/6-ws21-ping-a-after.png
[image-id-43]: images/7-apache2-ws22-r1.png
[image-id-44]: images/7-apache2-ws22-r1-start.png
[image-id-44.1]: images/7-ws22-ping.png
[image-id-45]: images/7-r2-rules.png
[image-id-46]: images/7-r2-rules-start.png
[image-id-47]: images/7-ws22-no-ping.png
[image-id-48]: images/7-r2-new-rules.png
[image-id-49]: images/7-r2-new-rules-start.png
[image-id-50]: images/7-ws22-yes-ping.png
[image-id-51]: images/7-r2-new-2-rules.png
[image-id-52]: images/7-r2-new-2-rules-start.png
[image-id-53]: images/7-ws22-snat.png
[image-id-54]: images/7-r1-dnat.png
[image-id-55.1]: images/8-firewall-start-1.png
[image-id-55.2]: images/8-firewall-start-2.png
[image-id-56]: images/8-apache2-conf.png
[image-id-56.1]: images/8-ws11-port-22.png
[image-id-56.2]: images/8-ws21-port-22.png
[image-id-56.3]: images/8-ws21-port-22.png
[image-id-57.1]: images/8-ws11-22-21-ssh-sshd-conf.1.png
[image-id-57.2]: images/8-ws11-22-21-ssh-sshd-conf.2.png
[image-id-57.3]: images/8-ws11-22-21-ssh-sshd-conf.3.png
[image-id-58.1]: images/8-ws11-22-21-ssh-sshd-conf-2.1.png
[image-id-58.2]: images/8-ws11-22-21-ssh-sshd-conf-2.2.png
[image-id-59.1]: images/8-ws11-22-21-sshd-status-3.1.png
[image-id-59.2]: images/8-ws11-22-21-sshd-status-3.2.png
[image-id-59.3]: images/8-ws11-22-21-sshd-status-3.3.png
[image-id-60]: images/8-ws21-local-tcp.png
[image-id-61]: images/8-ws11-remote-tcp.png
[image-id-62]: images/8-ws11-ws22-telnet.png


## Сети в Linux.

## Contents
- [Сети в Linux.](#сети-в-linux)
- [Contents](#contents)
- [Part 1. Инструмент ipcalc.](#part-1-инструмент-ipcalc)
- [Part 2. Статическая маршрутизация между двумя машинами.](#part-2-статическая-маршрутизация-между-двумя-машинами)
- [Part 3. Утилита iperf3.](#part-3-утилита-iperf3)
- [Part 4. Сетевой экран.](#part-4-сетевой-экран)
- [Part 5. Статическая маршрутизация сети.](#part-5-статическая-маршрутизация-сети)
  - [5.1. Настройка адресов машин:](#51-настройка-адресов-машин)
  - [5.2. Включение переадресации IP-адресов:](#52-включение-переадресации-ip-адресов)
  - [5.3. Установка маршрута по-умолчанию:](#53-установка-маршрута-по-умолчанию)
  - [5.4. Добавление статических маршрутов:](#54-добавление-статических-маршрутов)
  - [5.5. Построение списка маршрутизаторов:](#55-построение-списка-маршрутизаторов)
  - [5.6. Использование протокола ICMP при маршрутизации:](#56-использование-протокола-icmp-при-маршрутизации)
- [Part 6. Динамическая настройка IP с помощью DHCP:](#part-6-динамическая-настройка-ip-с-помощью-dhcp)
    - [1. У казать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.](#1-у-казать-адрес-маршрутизатора-по-умолчанию-dns-сервер-и-адрес-внутренней-сети)
    - [2. В файле resolv.conf прописать nameserver 8.8.8.8.](#2-в-файле-resolvconf-прописать-nameserver-8888)
- [Part 7. NAT:](#part-7-nat)
- [Part 8. Дополнительно. Знакомство с SSH Tunnels:](#part-8-дополнительно-знакомство-с-ssh-tunnels)

**Рекомендация.** 
Перед дальнейшими манипуляциями, во избежании лишних проблем, заранее обновите систему и установите утилиты для одной виртуальной машины, далее просто клонируйте ее сколько необходимо (ws11, ws21, r1, r2, ws22):
1. `sudo apt-get update && sudo apt-get upgrade`
2. `sudo apt-get install ipcalc`
3. `sudo apt-get install iperf3`
4. `sudo apt-get install iptables`
5. `sudo apt-get install nmap`
6. `sudo apt-get install traceroute`
7. `sudo apt install inetutils-traceroute`
8. `sudo apt install isc-dhcp-server`
9. `sudo apt install apache2`
10. `sudo apt install openssh-server`
11. `sudo apt-get install -y mcedit`

**Скачиваем `iso` образ для выполнения заданий и создания виртуальных машин (далее VM): ws11, ws21, r1, r2, ws22. [ubuntu-20.04-live-server](https://old-releases.ubuntu.com/releases/20.04.0/ubuntu-20.04-live-server-amd64.iso), далее следуем [инструкции](https://linuxconfig.org/how-to-install-ubuntu-20-04-on-virtualbox) по установке `iso` образа в VirtualBox.**

**Важно! Сохрание дампов образов виртуальных машин, после каждого выполненного Part задания**
* Справа от каждой VM есть кнопка с выпадающим меню **Details, Snapshots, Logs**. Выберите **Snapshots** и повяится окно сохранения состояния VM.
![image-id-a][]
* Нажмите кнопку **Take** и появится окно где для удобства, необходимо ввести имя соответствующему пунтку задания.
![image-id-b][]
Между состояниями VM можно переключатся в данном окне **перед новым запуском VM**, выбирая нужное состояние и далее нажимая кнопку **Restore**.
![image-id-с][]

## Part 1. Инструмент ipcalc.

1.1. Сети и маски:

**Вычислительная сеть.** Вычислительная сеть, или информационно-вычислительная сеть (компьютерная сеть) — система, обеспечивающая обмен данными между вычислительными устройствами — компьютерами, серверами, маршрутизаторами и другим оборудованием или программным обеспечением. Для передачи информации могут быть использованы различные среды передачи данных. Помимо совокупности физических устройств и физических средств передачи данных, вычислительная сеть может быть оверлейной или виртуальной, то есть логически самостоятельной выделенной сетью, использующей ресурсы другой физической сети — вычислительной (например Интернет), телефонной сети, в том числе ТФОП и (или) среды передачи данных.

**Классификация.** Существуют варианты классификации разных вычислительных сетей по назначению и характеристикам.

*По территориальной распространённости:*

- BAN (Body Area Network — нательная компьютерная сеть) — сеть надеваемых или имплантированных компьютерных устройств;
- PAN (Personal Area Network) — персональная сеть, предназначенная для взаимодействия различных устройств, принадлежащих одному владельцу;
- LAN (ЛВС, Local Area Network) — локальная сеть, имеющая замкнутую инфраструктуру до выхода на поставщиков услуг; может описывать и маленькую офисную сеть, и сеть уровня большого завода, занимающего несколько сотен гектаров; иногда определяется как сеть «около шести миль (10 км) в радиусе»; локальные сети являются сетями закрытого типа, доступ к ним разрешён только ограниченному кругу пользователей, для которых работа в такой сети непосредственно связана с их профессиональной  деятельностью;
- CAN (Campus Area Network) — кампусная сеть, объединяет локальные сети близко расположенных зданий;
- MAN (Metropolitan Area Network) — городские сети между учреждениями в пределах одного или нескольких городов, связывающие много локальных вычислительных сетей;
- WAN (Wide Area Network) — глобальная сеть, покрывающая большие географические регионы, включающие в себя как локальные сети, так и прочие телекоммуникационные сети и устройства. Пример WAN — сети с коммутацией пакетов (Frame relay), через которую могут «разговаривать» между собой различные компьютерные сети. Глобальные сети являются открытыми и ориентированы на обслуживание любых пользователей.

*По архитектуре:*

- клиент-сервер;
- одноранговая сеть (децентрализованная или пиринговая сеть).

*По типу сетевой топологии:*

- шина
- кольцо
- двойное кольцо
- звезда
- ячеистая
- решётка
- дерево
- смешанная топология
- Fat Tree

*По типу среды передачи:*

- проводная (телефонный провод, коаксиальный кабель, витая пара волоконно-оптический кабель);
- беспроводная (передача информации по радиоволнам в определённом частотном диапазоне)

*По функциональному назначению:*

- сеть хранения данных;
- серверная ферма;
- сеть управления процессом;
- Сеть SOHO, домовая сеть.

*По скорости передачи:*

- низкоскоростная (до 10 Мбит/с),
- среднескоростная (до 100 Мбит/с),
- высокоскоростная (свыше 100 Мбит/с);

*По сетевым операционным системам:*

- на основе Windows
- на основе Unix
- на основе NetWare
- на основе Cisco

*По необходимости поддержания постоянного соединения:*

- пакетная сеть, например, Фидонет и UUCP
- онлайновая сеть, например, Интернет и GSM

**Оверлейные сети.** Примеры самостоятельных логических вычислительных сетей, использующих другие физические сети и среды передачи данных:

- Коммутируемый (модемный) доступ
- Виртуальная частная сеть (VPN) и виртуальная локальная вычислительная сеть VLAN
- Даркнет
- Блокчейн

**Стеки протоколов.** При реализации компьютерной сети могут использоваться различные наборы протоколов, некоторые из них:

- AppleTalk
- ARCNET
- ATM
- DECnet
- Ethernet
- HIPPI
- IEEE-488
- IP
- IPX
- Myrinet
- TCP
- Token Ring
- UDP
- SPX
- FDDI
- QsNet
- USB
- IEEE 1394 (Firewire, iLink)
- X.25
- Frame relay
- Bluetooth
- IEEE 802.11
- Systems Network Architecture
- RapidIO

**Уровни.**

Сетевая модель OSI:

- Прикладной уровень
- Уровень представления информации
- Сеансовый уровень
- Транспортный уровень
- Сетевой уровень:
  - Коммутация
  - Маршрутизация
- Канальный уровень (Уровень связывания данных) — Спецификация IEEE 802 разделяет этот уровень на 2 подуровня — MAC (Media Access Control) регулирует доступ к разделяемой физической среде, LLC (Logical Link Control) обеспечивает обслуживание сетевого уровня.
- Физический уровень

**Передача данных.**

- Проводная связь:
  - Телефонная сеть PSTN
    - Модем и коммутируемый доступ
  - Выделенные линии
  - Коммутация пакетов
  - Frame relay
  - PDH
  - Ethernet
  - RS-232
  - Передача по оптоволоконному кабелю:
    - Synchronous optical networking
    - Fiber distributed data interface
- Беспроводная связь:
   Ближнего радиуса действия:
   - Bluetooth
   - Human Area Network
   Среднего радиуса действия:
   - IEEE 802.11
   - Netsukuku
   - IEEE 802.16e WiMAX
   Дальнего радиуса действия:
   - Спутниковая связь
   - MMDS
   - SMDS
   - Передача данных при помощи мобильных телефонов:
      - CSD
      - GPRS
      - HSCSD
      - EDGE
      - UMTS
      - HSDPA
      - HSUPA
      - CDMA
      - LTE
      - IEEE 802.16e WiMAX
      - CDPD
      - Paging networks
      - DataTAC
      - Mobitex
      - Motient

*IP-адрес (от англ. Internet Protocol) — уникальный числовой идентификатор устройства в компьютерной сети, работающей по протоколу IP.*

*В сети Интернет требуется глобальная уникальность адреса; в случае работы в локальной сети требуется любая уникальность адреса в пределах сети. В версии протокола IPv4 IP-адрес имеет длину 4 байта, а в версии протокола IPv6 — 16 байт.*

*IPv4. В 4-й версии IP-адрес представляет собой 32-битное число. Как правило, адрес записывается в виде четырёх десятичных чисел значением от 0 до 255 (эквиваленты четырём восьмибитным числам), разделённых точками, например, 192.168.0.3.*

*IPv6. В 6-й версии IP-адрес является 128-битным. Как правило, адрес записывается в виде восьми четырёхзначных шестнадцатеричных чисел (эквивалентны восьми 16-битным числам), разделённых двоеточиями, например, 2001:0db8:85a3:0000:0000:8a2e:0370:7334. Ведущие нули допускается в записи опускать. Нулевые группы, идущие подряд, могут быть опущены, вместо них ставится двойное двоеточие (fe80:0:0:0:0:0:0:1 можно записать как fe80::1). Более одного такого пропуска в адресе не допускается.*

***Структура.** IP-адрес состоит из двух частей: номера сети и номера узла. В случае изолированной сети её адрес может быть выбран администратором из специально зарезервированных для таких сетей блоков адресов (10.0.0.0/8, 172.16.0.0/12 или 192.168.0.0/16). Для выхода в глобальную сеть необходимо, чтобы был IP из другого блока адресов, либо в локальной сети должен быть сервер, подменяющий внутренний IP-адрес (серый) на внешний IP-адрес (белый), например: proxy server, NAT. Если же сеть должна работать как составная часть Интернета, то адрес сети выдаётся провайдером либо региональным интернет-регистратором (Regional Internet Registry, RIR). Согласно данным на сайте IANA, существует пять RIR: ARIN, обслуживающий Северную Америку, а также Багамы, Пуэрто-Рико и Ямайку; APNIC, обслуживающий страны Южной, Восточной и Юго-Восточной Азии, а также Австралии и Океании; AfriNIC, обслуживающий страны Африки и Индийского океана; LACNIC, обслуживающий страны Южной Америки и бассейна Карибского моря; и RIPE NCC, обслуживающий Европу, Центральную Азию, Ближний Восток. Региональные регистраторы получают номера автономных систем и большие блоки адресов у IANA, а затем выдают номера автономных систем и блоки адресов меньшего размера локальным интернет-регистраторам (Local Internet Registries, LIR), обычно являющимся крупными провайдерами.*

*IANA (от англ. Internet Assigned Numbers Authority — «Администрация адресного пространства Интернет») — функция управления пространствами IP-адресов, доменов верхнего уровня, а также регистрирующая типы данных MIME и параметры прочих протоколов Интернета. Исполняется компанией Public Technical Identifiers, которая находится под контролем ICANN.*

*Номер узла в протоколе IP назначается независимо от локального адреса узла. Маршрутизатор по определению входит сразу в несколько сетей. Поэтому каждый порт маршрутизатора имеет собственный IP-адрес. Конечный узел также может входить в несколько IP-сетей. В этом случае компьютер должен иметь несколько IP-адресов, по числу сетевых связей. **Таким образом, IP-адрес характеризует не отдельный компьютер или маршрутизатор, а одно сетевое соединение.***

***Типы адресации.** Есть два способа определения того, сколько бит отводится на маску подсети, а сколько — на IP-адрес. Изначально использовалась классовая адресация (INET), но со второй половины 90-х годов XX века она была вытеснена бесклассовой адресацией (CIDR), при которой количество адресов в сети определяется маской подсети.*

***Сравнение.** Иногда встречается запись IP-адресов вида «192.168.5.0/24». Данный вид записи заменяет собой указание диапазона IP-адресов. Число после косой черты означает количество единичных разрядов в маске подсети. Для приведённого примера маска подсети будет иметь двоичный вид 11111111 11111111 11111111 00000000 или то же самое в маршрутизаторе десятичном виде: «255.255.255.0». 24 разряда IP-адреса отводятся под номер сети, а остальные 8 разрядов полного адреса — под адреса хостов этой сети, адрес этой сети и широковещательный адрес этой сети. Итого, 192.168.5.0/24 означает диапазон адресов хостов от 192.168.5.1 до 192.168.5.254, а также 192.168.5.0 — адрес сети и 192.168.5.255 — широковещательный адрес сети. Для вычисления адреса сети и широковещательного адреса сети используются формулы:*

***адрес сети = IP.любого_компьютера_этой_сети AND MASK** (адрес сети позволяет определить, что компьютеры в одной сети)
**широковещательный адрес сети = IP.любого_компьютера_этой_сети OR NOT(MASK)** (широковещательный адрес сети воспринимается всеми компьютерами сети как дополнительный свой адрес, то есть пакет на этот адрес получат все хосты сети как адресованные лично им. Если на сетевой интерфейс хоста, который не является машрутизатором пакетов, попадёт пакет, адресованный не ему, то он будет отброшен).
В некоторых системах адрес сети и широковещательный могут быть поменяны местами (не проверено).*

***Запись IP-адресов с указанием через слэш маски подсети переменной длины, также называют CIDR, в противоположность обычной записи без указания маски, в операционных системах типа UNIX также именуемой INET.***

***Особые IP-адреса.** В протоколе IP существует несколько соглашений об особой интерпретации IP-адресов: если все двоичные разряды IP-адреса равны 1, то пакет с таким адресом назначения должен рассылаться всем узлам, находящимся в той же сети, что и источник этого пакета. Такая рассылка называется ограниченным широковещательным сообщением (limited broadcast). Если в поле номера узла назначения стоят только единицы, то пакет, имеющий такой адрес, рассылается всем узлам сети с заданным номером сети. Например, в сети 192.168.5.0 с маской подсети 255.255.255.0 пакет с адресом 192.168.5.255 доставляется всем узлам этой сети. Такая рассылка называется широковещательным сообщением (direct broadcast).*

***Статические (статичные) и динамические IP-адреса.** IP-адрес называют статическим (постоянным, неизменяемым), если он назначается пользователем в настройках устройства, либо назначается автоматически при подключении устройства к сети и не может быть присвоен другому устройству.*

*IP-адрес называют динамическим (непостоянным, изменяемым), если он назначается автоматически при подключении устройства к сети и используется в течение ограниченного промежутка времени, указанного в сервисе назначавшего IP-адрес (DHCP).*

*Для получения IP-адреса клиент может использовать один из следующих протоколов:*

- *BOOTP (RFC 951) — простой протокол настройки сетевого адреса, ранее использовался для бездисковых станций, ныне вытеснен DHCP.*
- *DHCP (RFC 2131) — наиболее распространённый протокол настройки сетевых параметров.*
- *IPCP (RFC 1332) в рамках протокола PPP (RFC 1661).*
- *Zeroconf (RFC 3927) — протокол настройки сетевого адреса, определения имени, поиск служб.*
- *RARP (RFC 903) Устаревший протокол, использующий обратную логику (из аппаратного адреса — в логический) популярного и поныне в широковещательных сетях протокола ARP. Не поддерживает распространения информации о длине маски (не поддерживает VLSM).*

1. Адрес сети *192.167.38.54/13: 192.160.0.0/13*  
![image-id-1][]

1. Перевод маски *255.255.255.0* в префискную и двоичную запись:
* CIDR: /24
* Mask: 255.255.255.0
* Binary mask: 11111111.11111111.11111111.00000000  
![image-id-2][]

   Перевод маски */15* в обычную и двоичную запись:
* CIDR: /15
* Mask: 255.254.0.0
* Binary mask: 11111111.11111110.00000000.00000000  
![image-id-3][]

   Перевод маски *11111111.11111111.11111111.11110000* в обычную и двоичную запись
* CIDR: /28
* Mask: 255.255.255.240
* Binary mask: 11111111.11111111.11111111.11110000  
![image-id-4][]

1. MIN host: *12.0.0.1* MAX host: *12.255.255.254*  
![image-id-5][]

   MIN host: *12.167.0.1* MAX host: *12.167.255.254*  
![image-id-6][]

   MIN host: *12.167.38.1* MAX host: *12.167.39.254*  
![image-id-7][]

   MIN host: *0.0.0.1* MAX host: *15.255.255.254*  
![image-id-8][]

1.2. localhost:

* Можно обратиться к приложению с IP: 127.0.0.2/24, 127.1.0.1/8

* Нельзя обратиться к приложению с IP: 194.34.23.100, 128.0.0.1

*Частный IP-адрес (англ. private IP address), также называемый внутренним, внутрисетевым или локальным — IP-адрес, принадлежащий к специальному диапазону, не используемому в сети Интернет. Такие адреса предназначены для применения в локальных сетях, распределение таких адресов никем не контролируется. В связи с дефицитом свободных IP-адресов провайдеры всё чаще раздают своим абонентам именно внутрисетевые адреса, а не внешние, при этом они все выходят в интернет через один внешний IP (так называемый «белый IP»).*

*Иногда частные адреса называют неанонсированными, внешние (так называемые «белые IP») — анонсированными.*

*Частные диапазоны IP-адресов. Следующие диапазоны определены IANA как адреса, выделенные **локальным** сетям IPv4: **10**.0.0.0 — 10.255.255.255 (маска подсети для бесклассовой (CIDR) адресации: 255.0.0.0 или /8) **100.64**.0.0 — **100.127**.255.255 (маска подсети 255.192.0.0 или /10) — Данная подсеть рекомендована согласно RFC 6598 для использования в качестве адресов для CGN (Carrier-Grade NAT). **172.16**.0.0 — **172.31**.255.255 (маска подсети: 255.240.0.0 или /12) **192.168**.0.0 — 192.168.255.255 (маска подсети: 255.255.0.0 или /16) Также для **петлевых** интерфейсов (**не используется для** обмена между узлами сети) зарезервирован диапазон **127**.0.0.0 — 127.255.255.255 (маска подсети: 255.0.0.0 или /8).*

1.3. Диапазоны и сегменты сетей:

IP бывают белые и серые (или публичные и частные). Публичным IP адресом называется IP адрес, который используется для выхода в Интернет. Адреса, используемые в локальных сетях, относят к частным. Частные IP не маршрутизируются в Интернете.

Публичные адреса назначаются публичным веб-серверам для того, чтобы человек смог попасть на этот сервер, вне зависимости от его местоположения, то есть через Интернет. Например, игровые сервера являются публичными, как и сервера Хабра и многих других веб-ресурсов.
Большое отличие частных и публичных IP адресов заключается в том, что используя частный IP адрес мы можем назначить компьютеру любой номер (главное, чтобы не было совпадающих номеров), а с публичными адресами всё не так просто. Выдача публичных адресов контролируется различными организациями.

Допустим, Вы молодой сетевой инженер и хотите дать доступ к своему серверу всем пользователям Интернета. Для этого Вам нужно получить публичный IP адрес. Чтобы его получить Вы обращаетесь к своему интернет провайдеру, и он выдаёт Вам публичный IP адрес, но из рукава он его взять не может, поэтому он обращается к локальному Интернет регистратору (LIR – Local Internet Registry), который выдаёт пачку IP адресов Вашему провайдеру, а провайдер из этой пачки выдаёт Вам один адрес. Локальный Интернет регистратор не может выдать пачку адресов из неоткуда, поэтому он обращается к региональному Интернет регистратору (RIR – Regional Internet Registry). В свою очередь региональный Интернет регистратор обращается к международной некоммерческой организации IANA (Internet Assigned Numbers Authority). Контролирует действие организации IANA компания ICANN (Internet Corporation for Assigned Names and Numbers). Такой сложный процесс необходим для того, чтобы не было путаницы в публичных IP адресах.
![image-id-8.1][]
Поскольку мы занимаемся созданием локальных вычислительных сетей (LAN — Local Area Network), мы будем пользоваться именно частными IP адресами. Для работы с ними необходимо понимать какие адреса частные, а какие нет. В таблице ниже приведены частные IP адреса, которыми мы и будем пользоваться при построении сетей.
![image-id-8.2][]

1. Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45/8, 134.43.0.2/16, 192.168.4.2/16, 172.20.250.4/12, 172.0.2.1/12, 192.172.0.1/12, 172.68.0.2/12, 172.16.255.255/12, 10.10.10.10/8, 192.169.168.1/16
            
        частные:
            10.0.0.45/8
            192.168.4.2/16
            172.20.250.4/12
            172.16.255.255/12
            10.10.10.10/8
            
        публичные:
            134.43.0.2/16
            172.0.2.1/12
            192.172.0.1/12 (частично частный, привелегированный)
            172.68.0.2/12
            192.169.168.1/16

2. какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255
         
            10.10.0.2
            10.10.10.10
            10.10.1.255

## Part 2. Статическая маршрутизация между двумя машинами.

**Далее слева **ws1**, справа **ws2**.**

* Смотрим существующие сетевые интерфейсы с помощью команды `ip a`:
![image-id-9][]

* Чтобы иметь возможность одновременно подключиться к внешней и локальной сети, а так же работать с виртуальной машиной через терминал ПК создаём дополнительный сетевой интерфейс (адаптер) для локальной виртуальной сети:
![image-id-9-0][]
![image-id-9-1][]
![image-id-9-2][]
![image-id-9-3][]
![image-id-9-4][]
![image-id-9-5][]
![image-id-9-6][]
![image-id-9-7][]
![image-id-9-8][]
![image-id-9-9][]
* Изменения в сетевые интерфейсы вносим с помощью `mcedit или vim /etc/netplan/00-installer-config.yaml`. Вывод содержания измененного файла `cat /etc/netplan/00-installer-config.yaml` для каждой машины:
![image-id-10][]
* Вызов команды `sudo netplan apply` для перезапуска сервиса сети, для каждой машины:
![image-id-10-1][]

1. Добавление статического маршрута вручную:
* Добавим статистический маршрут при помощи команды `sudo ip r add` и пропингуем `ping -c` соединение между машинами:
* **Важная заметка:** Если Вы не создали в Virtual Box по инструкции выше и не прописали в файле *.yaml второй сетевой интерфейс (адаптер), а только лишь изменили первый (enp0s3), то возможно при выполнении данной команды у вас возникнет ошибка **Destination host unreachable**. Решение проблемы для одного сетевого интерфейса: Devices > Network > Network Settings... Там по умолчанию будет NAT, смените на Bridged adapter и нажмите OK. 
![image-id-11][]

1. Добавление статического маршрута с сохранением:
* Изменения вносим с помощью `vim /etc/netplan/00-installer-config.yaml`. Добавим статический маршрут от одной машины до другой с помощью файла `cat /etc/netplan/00-installer-config.yaml`, перезапустим сервер сети и пропингуем соединение между машинами:
![image-id-12][]

## Part 3. Утилита iperf3.

3.1. Скорость соединения:

* 8 Mbps = 1 MB/s
* 100 MB/s = 800000 Kbps
* 1 Gbps = 1000 Mbps

3.2. Утилита iperf3:
* Выполняем команды на ws1 - `sudo iperf3 -s` и на ws 2 - `sudo iperf3 -c 192.168.100.10` 
![image-id-13][]

## Part 4. Сетевой экран.

4.1. Утилита iptables:

* Создаем файлы `sudo vim /etc/firewall.sh`
![image-id-14][]

* Запуск файлов на обеих машинах командами `sudo chmod +x /etc/firewall.sh` и `sudo sh /etc/firewall.sh`
![image-id-15][]

4.2. Утилита nmap:

* Командой ping находим машину, которая не "пингуется", после чего утилитой nmap показываем, что хост машины запущен
![image-id-16][]
* ws1 - OUTPUT для пакетов на ping-reply DROP - не работает т.е. пакеты отправляет, но не принемает.
* ws2 - OUTPUT для пакетов на ping-reply ACCEPT - работает.

**Сохранить дампы образов виртуальных машин. Инструкция в начале**

## Part 5. Статическая маршрутизация сети.

**В данном задании создайте 5 новых виртуальных машин. Можно взять iso образ виртуальной машины Ubuntu Server 20.04 по ссылке в начале и установить его в Virtual Box. Для ускорения процесса создания сети, можно клонировать виртуальные машины из образа машины, обновленной до последней версии как показано ниже:**
![image-id-16.1][]
![image-id-16.2][]
![image-id-16.3][]
![image-id-16.4][]

### 5.1. Настройка адресов машин:

* Сеть:
![image-id-17][]

* Вносим изменения для каждой из машин в Oracle VM VirtualBox Manager: 
  * Для **r1**, Settings > Network > Adapter 1 (Internal Network, r1-ws11), Adapter 2 (Internal Network, r1-r2), Adapter 3 (NAT)
  ![image-id-17.1][]
  ![image-id-17.2][]
  * Для **r2**: Settings > Network > Adapter 1 (Internal Network, r1-r2), Adapter 2 (Internal Network, r2-ws21-ws22), Adapter 3 (NAT)
  ![image-id-17.3][]
  ![image-id-17.4][]
  * Для **ws11**, Settings > Network > Adapter 1 (Internal Network, r1-ws11), Adapter 2 (NAT)
  ![image-id-17.5][]
  * Для **ws21, ws22**:  Settings > Network > Adapter 1 (Internal Network, r2-ws21-ws22), Adapter 2 (NAT)
  ![image-id-17.6][]
* 2 роутера (r1, r2):
![image-id-18][]

* 3 рабочие станции (ws11, ws22, ws21):
![image-id-19][]

* Перезапустить сервис сети командой `sudo netplan apply` и выполнить команду `ip -4 a` для каждой машины:
* 2 роутера (r1, r2):
![image-id-20][]

* 3 рабочие станции (ws11, ws22, ws21):
![image-id-21][]

* Пропингуйте ping ws22 с ws21 и ping r1 с ws11:
![image-id-22][]

### 5.2. Включение переадресации IP-адресов:

* Для включения переадресации IP, выполните команду на роутерах(r1, r2): `sudo sysctl -w net.ipv4.ip_forward=1`
![image-id-23][]

* Откройте на роутерах файл `sudo nano /etc/sysctl.conf` и добавьте в него следующую строку: **net.ipv4.ip_forward = 1**
![image-id-24][]

### 5.3. Установка маршрута по-умолчанию:

* Настроика маршрута по-умолчанию (шлюз) для рабочих станций(ws11, ws22, ws21):
* Вносим изменения для каждой из машин `sudo nano /etc/netplan/00-installer-config.yaml`
![image-id-25][]

* Вызвать ip r и проверяем, добавился ли маршрут в таблицу маршрутизации:
![image-id-26][]

* Пропингуем ws11 - r2; `sudo tcpdump -tn -i eth0`
![image-id-27][]
* Ошибка в Readme*, ниже показан вывод `sudo tcpdump -tn -i eth1` 
![image-id-27.1][]
![image-id-27.2][]
*Комментарий к ошибке: при отсутствии соответствующих правил маршрутизации в файлах конфигураций .yaml роутеров r1 и r2 невозможен трафик, и, соответственно, захват пакетов на интерфейсах, смотрящих в локальные подсети этих роутеров, отправленных с устройств этих подсетей, в локальную подсеть соседнего роутера.

### 5.4. Добавление статических маршрутов:

* Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.
![image-id-28][]

* Вызвать ip r и показать таблицы с маршрутами на обоих роутерах.
![image-id-29][]

* Запустить команды на ws11: `ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0`
![image-id-30][]
* Для адреса `10.10.0.0/[маска сети]` был выбран маршрут, отличный от `0.0.0.0/0`, потому что маска `/18` описывает маршрут к сети точнее, в отличие от маски `/0`.

Классические правила маршрутизации (М.) всегда ориентированы на IP-адрес назначения `dst_ip`, то есть куда адресован пакет.

После определения `dst_ip` процесс М. по определённому алгоритму сопоставляет правила таблицы маршрутизации (ТМ) с определённым `dst_ip`, подбирая соответствующее ему правило М.

При сопоставлении за основу принимается маска подсети (netmask). Если `dst_ip` входит в адресный диапазон сетевого интерфейса роутера, указанного в правиле ТМ, тогда пакеты трафика направляются на IP-адрес данного сетевого интерфейса роутера.

В то время как маршрут по умолчанию `default` имеет согласно этого алгоритма сопоставления самый низкий приоритет из всех возможных. Он применяется при выборе маршрута в случае соответствия `dst_ip` сразу нескольким сетевым интерфейсам ТМ, либо при его несоответствии ни одному из других правил в ТМ.

При настройке сетевого интерфейса прописывается 3 параметра: `IP-адрес`, `netmask`, IP-адрес основного шлюза `gateway`. Именно эти параметры принимаются ТМ, при этом создаётся новая запись (правило).

Рассмотрим пошагово как происходит определение маршрута на третьем уровне модели `OSI` при формировании заголовка `L3` в процессе М. после настройки сетевого интерфейса и сохранения правил М.:

1. При формировании пакета в заголовок 3 уровня (`L3`, модели `OSI`) передаётся известный изначально `dst_ip`.
2. dst_ip сопоставляется с IP-адресом сети, указанным в правилах (записях) ТМ в соответствии с приоритетом правила (является одним из параметров ТМ).
Для этого `netmask` применяется (накладывается) к `dst_ip` с помощью побитового И `AND`.
Затем, полученный резултьтат сложения `dst_ip` и `netmask` сетевого IP-адреса сетевого интерфейса роутера сопоставляется с IP-адресом сети.
Если `dst_ip` соответствует IP-адресу сети, после применения к нему маски сети, то данное правило применяется для М. пакетов трафика данного `dst_ip`.
Если не соответствует, то происходит сопоставление следующего по приоритету правила из ТМ.
Если соответствующее правило в ТМ не найдено, то применяется правило (маршрут) по умолчанию `default`, созданное пользователем при (администратором сети) при настройке сетевого подключения через интерфейс пользователя `UI`. В поле основной шлюз `gateway` указывается IP-адрес соответствующего основного шлюза (интерфейса маршрутизатора).
При этом в ТМ в колонках (столбцах) "Сетевой адрес `Network Address`" и "Маска подсети `Netmask`" автоматически присваивается значение: `0.0.0.0`
В колонке "Интерфейс `Interface`" присваивается значение IP-адреса из поля "Основной шлюз `gateway`" `UI`.
Таким образом, при сопоставлении любого `dst_ip` с сетевым IP-адресом: `0.0.0.0`, после наложения на dst_ip маски сети `0.0.0.0`, этот `dst_ip` "обнуляется" и соответствует сетевому адресу: `0.0.0.0` То есть, к нему применяется маршрут по умолчанию `default`.
3. После завершения М. становится известен IP-адрес назначения `srs_ip` заголовка 3 уровня (L3). Он соответствует IP-адресу сетевого интерфейса роутера, указанного в колонке `Interface` строки маршрута в ТМ, определённой при М.

Таким образом, для адреса `10.10.0.0/18` был выбран маршрут, отличный от `0.0.0.0/0` в соответствии с приоритетом, установленным процессом маршрутизации, согласно которому маршрут: `10.10.0.0/18 dev eth0 proto kernel scope link src 10.10.0.2` имеет более высокий уровень приоритета в сравнении с маршрутом по умолчанию: `default via 10.10.0.1 dev eth0 proto static`.

### 5.5. Построение списка маршрутизаторов:

* Запустить на r1 команду дампа: `tcpdump -tnv -i eth0` 
* При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21: `traceroute [адрес сети]`
![image-id-31][]
* Принцип работы traceroute:

Для определения промежуточных маршрутизаторов traceroute отправляет серию пакетов данных целевому узлу, при этом каждый раз увеличивая на 1 значение поля TTL («время жизни»). Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом. Первый пакет отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно сообщение ICMP, указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера). Затем traceroute повторяет отправку пакета, но уже с TTL, равным 2, что позволяет первому маршрутизатору пропустить пакет дальше.

Процесс повторяется до тех пор, пока при определённом значении TTL пакет не достигнет целевого узла. При получении ответа от этого узла процесс трассировки считается завершённым.

### 5.6. Использование протокола ICMP при маршрутизации:

* Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды: `tcpdump -n -i eth0 icmp`
* Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды: `ping -c 1 10.30.0.111`
![image-id-32][]

**Сохранить дампы образов виртуальных машин. Инструкция в начале**

## Part 6. Динамическая настройка IP с помощью DHCP:

**В данном задании используются виртуальные машины из Части 5.**

* Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:
#### 1. У казать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.
![image-id-33][]

#### 2. В файле resolv.conf прописать nameserver 8.8.8.8.
![image-id-34][]

* Перезагрузить службу DHCP командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21.
![image-id-35][]

* Пинг ws22 с ws21.  
![image-id-36][]

* Указать MAC адрес у ws11, для этого в `etc/netplan/00-installer-config.yaml` надо добавить строки: `macaddress: 10:10:10:10:10:BA, dhcp4: true`.  
![image-id-37.1][]
![image-id-37.2][]

* Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты: `sudo nano /etc/dhcp/dhcpd.conf` для машины r1
![image-id-38][]

* Для r1 настроить аналогично r2, в файле `resolv.conf` прописать nameserver `8.8.8.8`.
![image-id-39][]

* Перезагрузить службу DHCP командой `systemctl restart isc-dhcp-server`. Машину ws11 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес.
![image-id-40][]

* Запросить с ws21 обновление ip адреса. **До**:
![image-id-41][]
* Для отображения IP-адреса интерфейса eth0 можно использовать команду ip addr show eth0. Она покажет информацию о сетевом интерфейсе eth0, включая его IP-адрес. Если IP-адрес на интерфейсе не настроен, команда вернет пустой вывод для этого интерфейса.
* Сушествует множество способов (команд) запроса обновления ip адреса, вот некоторые из них:
* `sudo dhclient -v` - эта команда запускает DHCP-клиент на интерфейсе (например, eth0) с подробным выводом (-v), пытаясь получить настройки с DHCP-сервера в сети. Если клиент успешно получает настройки, он настраивает соответствующий IP-адрес, маску подсети, шлюз и DNS-серверы для этого интерфейса.
* `sudo dhclient -r -v` - выполняет освобождение IP-адреса, полученного от DHCP-сервера, на указанном интерфейсе. Флаг -r указывает на освобождение IP-адреса, а -v запускает процесс в режиме подробного вывода.
Когда команда выполняется, DHCP-клиент отправляет запрос серверу DHCP с просьбой освободить ранее выданный IP-адрес. Если запрос принят сервером, то клиент получит подтверждение об освобождении адреса и удалит соответствующую запись из своей таблицы.

* `sudo dhclient -r eth0` - для обновления IP-адреса интерфейса с помощью команды dhclient можно использовать флаг -r, который предназначен для освобождения текущего IP-адреса и запуска процесса запроса нового адреса у DHCP-сервера. После этого можно запустить команду `dhclient` без каких-либо дополнительных флагов для получения нового IP-адреса от DHCP-сервера. Для отображения текущего IP-адреса интерфейса (например, eth0) при использовании команды sudo dhclient можно использовать флаг -4, который указывает на использование только протокола IPv4. Таким образом, полная команда будет выглядеть следующим образом: sudo `dhclient -4 eth0`. После выполнения этой команды в выводе будет указан текущий IP-адрес интерфейса eth0.
Ответ "RTNETLINK answers: File exists" означает, что в сетевой конфигурации уже существует запись для указанного интерфейса с таким же IP-адресом, какой попытался назначить DHCP-сервер.
Это может произойти, например, если был назначен статический IP-адрес на интерфейсе, и DHCP-сервер также попытался назначить ему другой IP-адрес.
В таком случае, можно попробовать сначала удалить статическую конфигурацию интерфейса, а затем повторить попытку получения IP-адреса от DHCP-сервера.

* Командой `ip addr del [ip-address/netmask] dev [interface]` можно удалить статическую конфигурацию интерфейса. Например, `sudo ip addr del 192.168.1.10/24 dev eth0`. После этого можно повторить команду `sudo dhclient -4 eth0`, чтобы получить IP-адрес от DHCP-сервера.

* Запросить с ws21 обновление ip адреса. **После**:
![image-id-42][]

**Сохранить дампы образов виртуальных машин. Инструкция в начале**

## Part 7. NAT:

**В данном задании используются виртуальные машины из Части 5.**
1. ##### В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80, то есть сделать сервер Apache2 общедоступным.
![image-id-43][]

2. ##### Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1.
![image-id-44][]

3. ##### Пропинговать r1 с ws22 чтобы убедиться, что пакеты проходят, связь есть: `ping -c 4 10.100.0.11`
![image-id-44.1][]

4. ##### Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
* Удаление правил в таблице: `filter - iptables -F`
* Удаление правил в таблице "NAT": `iptables -F -t nat`
* Отбрасывать все маршрутизируемые пакеты: `iptables --policy FORWARD DROP`
![image-id-45][]

* Запустить файл, предоставив соответствующие права доступа к нему: `sudo chmod +x /etc/firewall.sh && sudo sh /etc/firewall.sh`. Проверить список всех правил командой `sudo iptables -L`
![image-id-46][]

* Пингуем ws22 и r1, пинг не проходит как и должно быть.
![image-id-47][]

5. ##### Добавить в файл ещё одно правило в фаервол r2:
* Разрешить маршрутизацию всех пакетов протокола ICMP с помощью правила: `iptables -A FORVARD -p icmp -j ACCEPT`. Это правило iptables для цепочки FORWARD, которая отвечает за пересылку пакетов между интерфейсами на маршрутизаторе:
`sudo` - запуск команды с правами суперпользователя;
`iptables` - утилита для настройки правил межсетевого экрана;
`-A`: добавить правило в цепочку (append),
`FORWARD`: цепочка таблицы фильтрации `FORWARD`, которая обрабатывает пересылаемые пакеты,
`-p icmp` указывает, что данное правило относится к протоколу ICMP (Internet Control Message Protocol), который используется для отправки сообщений об ошибках и других уведомлений между устройствами в сети.
`-j ACCEPT` означает, что если пакет соответствует данному правилу, он будет принят (accepted) и перенаправлен на указанный в цепочке FORWARD интерфейс.
Таким образом, данное правило позволяет проходить пакетам протокола ICMP через маршрутизатор. Это может быть полезно, например, для проверки доступности устройств в сети или для отладки сетевых проблем.
![image-id-48][]

* Запустить файл.  
![image-id-49][]

* Пингуем ws22 и r1, пинг проходит.
![image-id-50][]

1. ##### Добавить в файл ещё два правила в фаервол r2:
* Включить в фаервол (межсетевой экран) разрешение для трафика TCP пакетов с адресом назначения на 80 порт (destination port) с помощью команды `sudo iptables -A FORWARD -p tcp --dport 80 -j ACCEPT`.
Данное правило iptables в Linux Ubuntu Server 20.04 позволяет пропустить через межсетевой экран трафик TCP-пакетов с адресом назначения на порту 80 через межсетевой экран (firewall)
*Подробное описание параметров*:
`-A FORWARD` - добавление правила в цепочку FORWARD, отвечающую за пересылку пакетов между интерфейсами;
`-p tcp` - указание протокола, в данном случае TCP;
`--dport 80` - указание порта назначения, в данном случае 80 (стандартный порт HTTP);
Таким образом, данное правило позволяет пропустить TCP-трафик, направленный на порт 80, через межсетевой экран. Это может быть полезно, например, для разрешения доступа к веб-серверу, расположенному за межсетевым экраном, для пользователей внешней сети.
* Включить разрешение прохождения для трафика TCP пакетов через межсетевой экран с адресом источника на 80 порт (source port) с помощью команды `sudo iptables -A FORWARD -p tcp --sport 80 -j ACCEPT`. Отличие данного правила от предыдущего заключается в проверке порта источника (source port) в TCP-пакете:
`--sport 80`: определяет порт источника (source port) в TCP-пакете. В данном случае, это порт 80, который обычно используется для HTTP-запросов.
Предыдущее правило разрешает прохождение трафика на TCP-порту назначения (destination port), а данное правило разрешает прохождение трафика на TCP-порту источника (source port). Вместе они могут использоваться, например, для разрешения входящих и исходящих HTTP-запросов через межсетевой экран.
* Включить `SNAT`, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть `10.20.0.0`) с помощью правила настроек `NAT` для `POSTROUTING` цепочки в таблице `NAT`: `sudo iptables -t nat -A POSTROUTING -o eth0 -s 10.20.0.0/26 -j SNAT --to-source 10.100.0.12`.
*Описание параметров*:
`-t nat`: опция указывает таблицу nat, которая используется для настройки NAT.
`-A POSTROUTING`: опция указывает, что правило должно быть добавлено в цепочку POSTROUTING таблицы nat. POSTROUTING цепочка применяет правила к пакетам, которые покидают сервер и отправляются во внешнюю сеть.
`-o eth0`: опция указывает интерфейс, через который пакеты покидают сервер. В этом случае пакеты, которые покидают сервер, отправляются через интерфейс eth0.
`-s 10.20.0.0/26`: опция указывает исходный IP-адрес для пакетов, которые будут обработаны правилом. В этом случае пакеты с IP-адресами в диапазоне `10.20.0.0 до 10.20.0.63` будут обработаны правилом.
-j SNAT: опция указывает действие, которое будет выполнено, если пакет соответствует правилу. В этом случае действие SNAT используется для изменения исходного IP-адреса отправителя пакета.
`--to-source 10.100.0.12`: опция указывает IP-адрес, на который нужно изменить исходный адрес отправителя пакета. В этом случае исходный адрес отправителя пакета будет изменён на `10.100.0.12`.
Таким образом, данное правило изменяет исходный IP-адрес пакетов, проходящих через выходной интерфейс enp0s8, и имеющих исходный IP-адрес в диапазоне `10.20.0.0/26, на 10.100.0.12.`
Отличие от предыдущего правила (`sudo iptables -A FORWARD -p tcp --dport 80 -j ACCEPT`) заключается в том, что это правило настраивает NAT для изменения исходного IP-адреса отправителя пакетов, а не просто разрешает прохождение пакетов с определенным портом.

* Включить `DNAT` на `8080` порт машины `r2` и добавить к веб-серверу `Apache`, запущенному на `ws22`, доступ извне сети с помощью следующего правила настройки `DNAT`: `iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 8080 -j DNAT --to-destination 10.20.0.20:80`.
Это правило iptables является правилом `NAT (Network Address Translation)` и определяет, что трафик, поступающий на сетевой интерфейс `eth0` с портом назначения `8080` и протоколом `TCP`, должен быть перенаправлен на IP-адрес `10.20.0.20` с портом назначения `80` (по умолчанию для HTTP). Ключевое слово `DNAT` означает, что происходит изменение адреса назначения (`Destination NAT`).
*Описание параметров*:
`-t nat`: устанавливает таблицу NAT, которая используется для изменения сетевых адресов.
`-A PREROUTING`: добавляет правило в цепочку `PREROUTING` таблицы `NAT`, которая обрабатывает входящий трафик до того, как он пройдет маршрутизацию.
`-i eth0`: задает интерфейс входящего трафика.
`-p tcp`: указывает протокол, которому принадлежит трафик.
`--dport 8080`: указывает порт назначения трафика.
`-j DNAT`: указывает, что нужно изменить адрес назначения пакета.
`--to-destination 10.20.0.20:80`: указывает новый адрес и порт, на который нужно перенаправить трафик.
Отличие от предыдущего правила заключается в том, что это правило применяется на входящий трафик (`PREROUTING`), тогда как предыдущее правило применяется на исходящий трафик (`POSTROUTING`). Также ключевое слово `DNAT` используется в этом правиле для изменения адреса назначения, в то время как в предыдущем правиле использовалось ключевое слово `SNAT` для изменения адреса источника.
![image-id-51][]

* Запустить файл.  
![image-id-52][]

**Перед тестированием рекомендуется отключить сетевой интерфейс NAT (его наличие можно проверить командой ip a) в VirtualBox, если он включен**

* Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой: `sudo telnet 10.100.0.11 80`
![image-id-53][]

* Проверить соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080):  
![image-id-54][]

**Сохранить дампы образов виртуальных машин. Инструкция в начале**

## Part 8. Дополнительно. Знакомство с SSH Tunnels:

**В данном задании используются виртуальные машины из Части 5.**
* ##### Запустить на r2 фаервол с правилами из Части 7.
![image-id-55.1][]
* ##### Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменить строку Listen 80 на Listen localhost:80). После введите `service apache2 start`
![image-id-56][]

**Крайне важный момент, у вас может быть активен порт 2022, а нужен 22. Проделайте операции изменения (добавления) порта для машин ws11, ws22, ws21.**
**Например, для ws22: Settings > Network > Adapter 1 (Internal Network, intnet), Adapter 2 (NAT), во втором адаптере нажать Advanced > Port Forfarding > зеленую кнопку Add new port forwarding rule > Host port 80 > Guest port 22**
![image-id-56.1][]
![image-id-56.2][]
![image-id-56.3][]

В файле `~/etc/ssh/sshd_config`:
* Меняем Port 2022 на Port 22
* Раскоментите ListenAddress 0.0.0.0
* Раскоментите ListenAddress ::
![image-id-57.1][]
![image-id-57.2][]
![image-id-57.3][]
* Закоментите Port 2022, если данная строка имеется в  файле `sshd_config` вашей виртуальной машины. Строка #Port 2022 определяет, на каком порту будет слушать ssh-сервер. Если эта строка отсутствует, то ssh-сервер будет слушать на порту по умолчанию - 22. Отсутствие строки #Port 2022 в вашем файле `sshd_config` не является ошибкой, поскольку ssh-сервер будет использовать порт по умолчанию (22), если параметр Port не указан явно.
Также стоит иметь ввиду, что вместо строки #Port 2022 в файле `sshd_config` вашей виртуальной машины может быть прописана строка `#GatewayPorts no`. Строка `#GatewayPorts` no отвечает за то, разрешено ли ssh-соединениям, созданным на удалённой машине, использовать проброс портов на локальной машине (которая запустила ssh-клиента). Если значение параметра установлено в `no`, то доступ к проброшенным портам будет разрешён только с локальной машины, а если в `yes`, то доступ будет разрешён и с других машин.
![image-id-58.1][]
![image-id-58.2][]
* Перезапустите sshd: `sudo systemctl restart sshd`
* Проверьте статус sshd: `sudo systemctl status sshd`
* Аналогичные результаты для ws22 и ws21.
![image-id-59.1][]
![image-id-59.2][]
![image-id-59.3][]

* ##### Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21.
Для этого используйте следующий шаблон команды `ssh -L local_port:remote_ip:remote_port user@remote_ip`. В нашем случае команда будет выглядеть так: `ssh -L 8888:10.20.0.20:80 shor@10.20.0.20`
![image-id-60][]

* ##### Воспользоваться Remote TCP forwarding c ws11 до ws22.
Чтобы воспользоваться `Remote TCP forwarding` c `ws11` до `ws22`, и получить доступ к веб-серверу на `ws22` с `ws11`, необходимо изменить правила `iptables` в фаерволе на роутере `r2`, и затем перезапустить его, добавив (открыв) в них соответствующие исходные `(source)` порты и порты назначения `(destination)`, неободимые для перенаправления пакетов по ssh-соединению следующим образом:
`sudo iptables -A FORWARD -p tcp -m multiport --dports 22,80,8080 -j ACCEPT`: это правило добавляет в цепочку `FORWARD` таблицы фильтрации пакетов `iptables` правило, которое разрешает пересылку (forwarding) TCP-пакетов, адресованных на порты `22, 80 и 8080`.
`sudo iptables -A FORWARD -p tcp -m multiport --sports 22,80,8080 -j ACCEPT`: это правило iptables отвечает за разрешение соединений TCP с портами отправителя (source ports) 22, 80 и 8080 через цепочку FORWARD.
Отличие от предыдущего правила заключается в том, что предыдущее правило фильтрует по портам отправителя, а это правило фильтрует по портам назначения. Соответственно, первое правило разрешит все соединения, где исходящие порты будут 22, 80 или 8080, а второе разрешит все соединения, где порты назначения будут 22, 80 или 8080.
`-m multiport`: модуль, который позволяет указывать несколько портов для одного правила;
`--dports 22,80,8080`: порты назначения, на которые разрешен доступ (destination ports);
`--sports 22,80,8080`: фильтр по портам отправителя, разрешает соединения с портами 22, 80 и 8080.
Для перезапуска фаервола, используйте команду:
`sh /etc/firewall.sh`
![image-id-55.2][]
Теперь можно воспользоваться Remote TCP forwarding. Для этого используйте следующий шаблон команды `ssh -R local_port:remote_ip:remote_port user@remote_ip`. В нашем случае для соединения по ssh с ws21 до ws22 команда будет выглядеть так: `ssh -R 8888:10.20.0.20:80 shor@10.20.0.20` Команда устанавливает удаленное TCP-проброску порта. Она создает проброску для удаленного порта `8888` на локальном хосте к порту 80 на удаленном хосте с IP-адресом `10.20.0.20` через SSH-соединение.
Правила файервола, которые разрешают трафик на портах `22, 80 и 8080` для TCP-протокола, не должны помешать установке SSH-соединения. Однако, правила, которые разрешают трафик на портах, с которых отправляется трафик (sport), могут быть проблемой.
В данном случае, команда устанавливает проброс для удаленного порта `8888`, который является исходным портом на удаленной машине. Следовательно, при использовании данной команды, фаервол не должен блокировать исходящий трафик с порта 8888 на удаленной машине. Если фаервол заблокирует трафик на этом порту, то проброс не будет работать.
Порт, на который происходит проброс (в данном случае 8888), не должен быть заблокирован фаерволом, но это не имеет отношения к правилам, которые разрешают трафик на портах с которых отправляется трафик `(sport)` или портах, на которые приходит трафик `(dport)`.
![image-id-61][]

* ##### Проверьте, сработало ли подключение в обоих предыдущих пунктах.
Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду по следующему шаблону: `telnet 127.0.0.1 [локальный порт (данного хоста)]` В нашем случае команда будет выглядеть так: `telnet 127.0.0.1 80`
![image-id-62][]

**Сохранить дампы образов виртуальных машин. Инструкция в начале**